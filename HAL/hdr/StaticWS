;
; Copyright (c) 2012, RISC OS Open Ltd
; Copyright (c) 2012, Adrian Lees
; All rights reserved.
;
; Redistribution and use in source and binary forms, with or without
; modification, are permitted provided that the following conditions are met: 
;     * Redistributions of source code must retain the above copyright
;       notice, this list of conditions and the following disclaimer.
;     * Redistributions in binary form must reproduce the above copyright
;       notice, this list of conditions and the following disclaimer in the
;       documentation and/or other materials provided with the distribution.
;     * Neither the name of RISC OS Open Ltd nor the names of its contributors
;       may be used to endorse or promote products derived from this software
;       without specific prior written permission.
; 
; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
; ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
; LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
; CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
; SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
; INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
; CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
; ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
; POSSIBILITY OF SUCH DAMAGE.
;
; With many thanks to Broadcom Europe Ltd for releasing the source code to
; its Linux drivers, thus making this port possible.
;

;                GET     Hdr:OSEntries
;                GET     Hdr:HALDevice
;                GET     Hdr:SDHCIDevice
;                GET     Hdr:DMADevice
                GET     hdr/BCM2835

; Per-timer workspace layout
                            ^             0
Timer_Reload                #             4       ; interval between interrupts
Timer_Compare               #             4       ; soft copy of most recently programmed compare value
Timer_Register              #             4       ; address of compare register
Timer_Device                #             4       ; device number
TimerWsSize                 *             :INDEX: @

; Per-DMA channel workspace
;                       ^ 0, a1
;DMACDevice             # HALDevice_DMAL_Size
;DMACWorkspace          # 4 ; HAL workspace ptr
;DMACChanMask           # 4 ; DMA_ENABLE bit for this channel
;DMACDREQ               # 4 ; Peripheral/DREQ this channel is servicing
;DMACOptions            # 4 ; Options set by SetOptions
;DMACPeriAddress        # 4 ; VC phys addr of peripheral - i.e. at &7e......
;DMACLastProgress       # 4 ; Last progress value
;DMACLastCONBLK_AD      # 4 ; Last control block seen executing
;DMACLastTXFR_LEN       # 4 ; Last transfer length remaining seen
;DMACCBOffset           # 4 ; Address offset to convert DMA CB addr to ARM CB addr
;DMACDesc               # 32 ; Buffer for description string
;DMAC_DeviceSize        * :INDEX: @

; VCHIQ HAL device layout

;                                 ^ 0
;                                 # HALDeviceSize
;HALDevice_VCHIQARMToVCOffset     # 4
;HALDevice_VCHIQVCDoorbell        # 4 ; Doorbell to interrupt VC
;HALDevice_VCHIQARMDoorbell       # 4 ; Doorbell to interrupt us
;HALDevice_VCHIQInitVC            # 4
;HALDevice_VCHIQ_Size             * :INDEX: @

; Main workspace layout

sb              RN      9

                ^       0,sb

PeriBase        #       4
IRQ_Base_Address #      4
ARM_Counter_IO_Address # 4
ARM_Timer_IO_Address #  4
UARTFCRSoftCopy #       4
MMUOffBaseAddr  #       4                    ; original address kernel was loaded from
MachineID       #       8                    ; derived from MAC address if there

Timer   SETA    0
        WHILE   Timer < NumTimers
Timer$Timer.Ws  #       TimerWsSize
Timer   SETA    Timer + 1
        WEND

FB_Base         #       4
FB_Size         #       4
FB_CacheMode    #       4

; info interrogated from the VC side
VC_Memory       #       4
ARM_Memory      #       4

; align to 16 byte boundary NB this isnt aligned once hal initialised
                #       (((:INDEX:@)+15):AND::NOT:15)-(:INDEX:@)
 ! 0,"tagbuffer at ":CC::STR:(&fc001000+:INDEX:@)
tagbuffer       #       256 ;; for now                      ; platform query buffer

; align to 16 byte boundary  NB this isnt aligned once hal initialised      
                #       (((:INDEX:@)+15):AND::NOT:15)-(:INDEX:@)
mbram           # 0                   ; structure needed for frame buffer descriptor
mbxres          #       4
mbyres          #       4
mbxvres         #       4
mbyvres         #       4
mbpitch         #       4
mbbpp           #       4
mbxoff          #       4
mbyoff          #       4
mbbase          #       4
mbscrsz         #       4

ScreenBase      #       4
FTextPixel      #       4
BTextPixel      #       4
FTextPixRepl    #       4
BTextPixRepl    #       4
BitsPerPixel    #       4
InvertFont      #       4
InvertPixel     #       4
Columns         #       4
Rows            #       4
OutputX         #       4
OutputY         #       4
BytesPerRow     #       4
BytesPerChar    #       4
LastInt         #       4
KM_State        #       4
KM_Num          #       4
KM_NumY         #       4
PixelTable      #       256*4

CurAddr         #       4
CurHeight       #       4
CurPalette      #       4*4
vrmsize         *       :INDEX: @ - :INDEX:mbram


NCNBAddr        #       4       ;NCNB workspace
NCNBPhysAddr    #       4       ;VC physical address of NCNB workspace

;OSheader        #       4
;OSentries       #       4*(HighestOSEntry+1)



; ! 0,"SDHCI at ":CC::STR:(&FC0001D8+:INDEX:@)
;SDHCIWriteInterval #    4 ; minimum counter ticks between writes
;SDHCILastWriteCount #   4 ; counter value at last write
;SDHCIInputClock #       4 ; estimated speed of input clock to SDHCI block
                #       (16-:INDEX:@):AND:15         ; align nicely
;SDHCIDevice     #       HALDevice_SDHCISize          ; see Hdr:SDHCIDevice
;SDHCISlotInfo   #       HALDeviceSDHCI_SlotInfo_Size ; the controller has just the 1 slot

;DMAFreeChannels #       4 ; Mask of which physical DMA channels are free
;DMANumChannels  #       4 ; Count of how many channel devices exist
;DMAChannelList  #       DMA_CH_Count*4 ; List of channel devices for Enumerate
                #       (16-:INDEX:@):AND:15         ; align nicely
;DMAController   #       HALDevice_DMAC_Size_0_1      ; see Hdr:HALDevice
;DMAChannels     #       DMAC_DeviceSize*DMA_CH_Count ; List of channel devices (indexed by physical channel #)

CurUnder        #       32*4*32
CurShape        #       32/4*32

;VCHIQDevice     #       HALDevice_VCHIQ_Size

HAL_WsSize              *       :INDEX:@
sizeof_workspace        *       :INDEX:@

                END
